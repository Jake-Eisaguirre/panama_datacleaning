---
title: "panama_cleaning"
author: "Jake Eisaguirre"
date: "7/6/2022"
output: html_document
---

# packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require(librarian)){
  install.packages("librarian")
  library(librarian)
}

# librarian downloads, if not already downloaded, and reads in needed packages

librarian::shelf(tidyverse, here, janitor, lubridate, parsedate, data.table)

```

# read in the data
```{r}

pan_data <- read_csv(here("data", "panama_data.csv")) %>% 
  clean_names() # <- this function attempts to clean column names

```

# I am now going to split the data apart. The first data frame will contain meta_data and environmental variables
```{r}

md_enviro <- pan_data %>% 
  select(c((1:35), detection_type, salinity0)) %>% 
  relocate(detection_type, .before = survey_time)

```


### Now I will be making the `nofrog` column binary (1 = present and 0 = absent) and calling it `frog_presence`
```{r}

enviro <- md_enviro %>% 
  mutate(frog_presence = ifelse(!nofrog == "No frogs", 1, 0 )) %>% 
  mutate_at(vars(frog_presence), ~replace_na(., 1))




# now remove old column and re-position frog_presence column

binary_environ <- enviro %>% 
  select(!c(nofrog)) %>% 
  relocate(frog_presence, .before = observers)
  

```

### I am now going to format the `date` for ISO 8601
```{r}

date_environ <- binary_environ %>% 
  mutate(date = parse_date(date))


```

### I am going to rename columns to include units
```{r}

var_environ <- date_environ %>% 
  rename(duration_minutes = surv_length,
         elevation_m = elevation, # double check this is correct
         wind_speed_m_s = wind_speed, # need to double check kph, I see some showing "0.4/s"
         air_temp_c = air_temp, # double check this is correct
         water_temp_c = water_temp, # double check this is correct
         dissolved_o2_percent = dis_o2, # insert units
         conductivity_insertunits = conductivity, #insert units
         tds_insertunits = tds, # insert units
         salinity_insertunits = salinity, # insert units
         cloud_cover_percent = cloud_cover,# double check this is correct
         humidity_percent = humidity, # double check this is correct
         pressure_hg = pressure_in_hg,
         number_observers = num_obs,
         salinity_moredetail = salinity0) 

```

### filter for irregular wind  values and get swab ids for those values
```{r}

# wind <- var_environ %>% 
#   filter(wind_speed_m_s %in% c("2.0, gust to 3.7", "1.1ph", "1.7 kt", "0ph", "3.9ph", ".4/s", "1.5ph", "1ph", "2ph",
#                              "1.7ph", "0.8 ph", "2.5 ph", "1.5 ph", "1.9 k/hr", "0.4/s", "1/s")) %>% 
#     select(c(wind_speed_m_s, swab_id, survey_id, region, site, date, detection_type, survey_time)) %>% 
#   mutate(correct_wind = "")
# 
# write_csv(wind, here("wind_data_check.csv"))

```

#### filter for irregular dis_02 values and get swab ids
```{r}
# dis_o2 <- var_environ %>% 
#   filter(dissolved_o2_percent > 100) %>% 
#   select(dissolved_o2_percent, swab_id, survey_id, region, site, date, detection_type, survey_time) %>% 
#   mutate(correct_o2 = "")
# 
# write_csv(dis_o2, here("dis_02_check.csv"))

```

#### filter for irregular salinty values and get swab ids
```{r}

# sal <- var_environ %>% 
#   filter(salinity_insertunits > 0.1) %>% 
#   select(salinity_insertunits, swab_id, survey_id, region, site, date, detection_type, survey_time) %>% 
#   mutate(correct_salinity = "")
# 
# write_csv(sal, here("sal_check.csv"))

```

### pull out both salinity columns and compare metrics
```{r}
# 
# both_salin <- var_environ %>% 
#   select(c(salinity_moredetail, salinity_insertunits, swab_id, survey_id, region, site, date, detection_type, survey_time))
# 
# write_csv(both_salin, here("bothSal_check.csv"))
```


### make all text lower case and select important survey md
```{r}

survey_table <- mutate_all(var_environ, str_to_lower) %>% 
  select(c((1:5), (6:15), (21:35), salinity_moredetail))

```

### create `visit_table` from `survey_table`
```{r}

#unique relationship for the visit_table is found in the date and survey time (night or day)
visit_table <- survey_table %>% 
  select(c(sort_id, merge_id, survey_id, date, survey_time, notes_survey, region, site)) %>% 
  group_by(date, survey_time) %>% 
  mutate(visit_id = cur_group_id()) %>% # add unique id based on date and survey time
  filter(!duplicated(visit_id)) # filter out duplicated unique id values

```

### save `visit_table` csv
```{r}

write.csv(visit_table, here("data", "visit_table.csv"))

```


### add `new_survey_id` based on date and detection type
```{r}

#survey table unique relationship is the date and detection type
survey_table <- survey_table %>% 
  select(!c(notes_survey)) %>% 
  mutate(survey_id = as.numeric(survey_id)) %>% 
  group_by(date, detection_type) %>% 
  mutate(new_survey_id = cur_group_id()) %>% #add unique id based on date and detection type
  filter(!duplicated(new_survey_id)) # filter out duplicated unique id values

  
```

### save `survey_table` csv
```{r}

write.csv(survey_table, here("data", "survey_table.csv"))

```


### Pull out site data for `sites_table` and add unique id
```{r}

site_data <- var_environ %>% 
  select(c(sort_id, merge_id, survey_id, region, site, utmz, utme, utmn, var_m, elevation_m))

# site table unique relationship is the site and region
site_table <- site_data %>% 
  group_by(site, region) %>%
  mutate(location = "Panama") %>% 
  mutate(site_id = cur_group_id()) %>% # unique id based on site and region
  filter(!duplicated(site_id)) %>% # filter out duplicated values
  mutate(region = str_to_lower(region),
         site = str_to_lower(site))


```


### save sites data csv
```{r}

write.csv(site_table, here("data", "site_table.csv"))

```


# Next we will clean up the biological data
```{r}

surv <- pan_data %>% 
  select(c(date, detection_type, (1:3),(36:72))) %>% 
  mutate(date = parse_date(date)) %>% # convert to iso 8601 date format
  select(!c(salinity0))

```


### create binary `infection_status` (infected = 1, unifected = 0) column and combine the two binary columns `infected` and `unifected`
```{r}

infec_status_bio <- surv %>% 
  mutate(infection_status = ifelse(infected == 1, 1, 0))

# now remove old columns and re-position infection_status column

infec_status_bio <- infec_status_bio %>% 
  select(!c(infected, uninfected)) %>% 
  relocate(infection_status, .before = pcr)

```

### rename columns to include units
```{r}

col_clean_bio <- infec_status_bio %>% 
  rename(count = quantity,
         capture_tx_loc = capture_loc, # double check this is rigth interpetation 
         body_temp_c = body_temp, # double check this is the right unit
         subs_temp_c = subs_temp, # double check this is the right unit
         svl_mm = svl, # need units
         frog_mass_g = frog_mass, # double check this is the right unit
         life_stage_moredetail = life_stage0, # need more detail
         microhab_moredetail = microhab0, # need more detail
         location_moredetail = location0, # need more detail
         photo_captured = photo,
         detection_time = capture_time)# need more detail

```

### make `life_stage_moredetail` all lower case
```{r}

clean_bio <- col_clean_bio %>% 
  mutate(life_stage_moredetail = str_to_lower(life_stage_moredetail))

```

### pull out irregular svl and get swab  id
```{r}

# ireg_svl <- clean_bio %>% 
#   filter(svl_mm <= 10) %>% 
#   select(swab_id, svl_mm, date, survey_id, detection_type) %>% 
#   mutate(correct_svl = "")
# 
# write_csv(ireg_svl, here("svl_check.csv"))

```



### Now we want to pull table `col_clean_bio` apart for the 2 different detection types: `capture` and `call`/`visual`
```{r}
vis_call_bio <- clean_bio %>% 
  filter(detection_type %in% c("call", "visual")) %>% 
  select(!c(dead, infection_status, pcr, bdswab, gen_samp, bacteria_swab, am_ps, notes_species_merge,
            notes_pc_rdata, missing_dat, swab_id)) %>% #filter call and visual surveys then remove any species 
                                                        #level biological data columns with no data associated 
    mutate(vis_call_id = row_number())


capture_bio <- clean_bio %>% 
  filter(detection_type == "capture") %>% 
  mutate(capture_id = row_number()) %>% 
  mutate(notes_pcr_data = gsub( "[[:punct:]]" , " ", notes_pc_rdata), # remove strange punctuation found in columns that was messing up DB
         qaq_csp = gsub("[[:punct:]]" , " ", qaq_csp))



```

### Now save the two tables `vis_call_bio` and `capture bio`
```{r}

write.csv(vis_call_bio, here("data", "visusal_aural.csv"))

write.csv(capture_bio, here("data", "capture.csv"))

```


